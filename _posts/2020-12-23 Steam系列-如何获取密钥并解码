

最近一段时间，因业务问题，要优化用户云游戏终端启动steam游戏，因此针对该议题进行了处理，做个记录。

steam平台有2种令牌类型：邮箱令牌、手机令牌，他们的区别在于邮箱令牌是由steam服务端发送邮箱验证码到邮箱，而手机令牌则是在手机steam应用中生成了验证码，每30秒会过期重复生成。

知道这两种区别之后，任务就清晰起来了，我们需要知道的就是怎么去获取用户的令牌文件，让玩家每次登录或启动游戏时，无需重复输入令牌了。

邮箱令牌比较简单，之后有时间我会重新记录一下，本次的重点针对的是手机令牌，好了，我们来看看思路：

1. 弄清楚手机令牌的业务规则
2. 弄清楚手机令牌的生成规则
3. 弄清楚生成规则是否可解密
4. 弄清楚解密文件是否可复用

以上就是我们所要了解解决的问题了，我们依次看看。

一、我们来看看如何获取吧

1、手机令牌是steam为了加强用户账号的安全而设计的风控功能，用户开启账号后，每次在新设备登录时，系统需要对其进行安全验证码校验，除此之外，绑定或解除令牌，也均会影响到交易功能。
2、手机令牌生成机制是动态生成的，每30秒会更新一次，即使断网也不受影响，也就是说，令牌的生成是在本地的，steam服务端会通过时间戳或其他方式，生成一组验证码，每次校验时，通过这个码跟服务端做校验，
这种编码一般采用TOTP算法（TOTP是基于散列的消息认证码（HMAC）的示例。 它使用加密哈希函数将密钥与当前时间戳组合在一起以生成一次性密码），也就是说我们需要找到保存在本地的令牌文件。令牌文件需要
手机root，是隐藏文件，通过强大的google搜索，找到一条描述，翻译一下：
  #从安卓设备上获取你的秘钥
  当你在安卓设备上安装了Steam的APP后,你将可以在该应用中生成你的二步验证密码.对于我们而言,我们仅需要做的仅仅是从中获取shared_serect_key.
  目前你都只能使用已经root的手机获取到该数据. (万恶的V社最近修复了不用ROOT的办法):
  如果你的手机已经被root,你将可以使用文件管理浏览到该文件,找到后并使用记事本打开编辑.
  文件路径是:
  /data/data/com.valvesoftware.android.steam.community/f/Steamguard-STEAMID64
  如果你的手机未被ROOT,你将无法访问到这部分的数据,即使你安装了根目录文件管理器
  在该文件中,你将找到如下的一个变量,其####的部分就是你所需的秘钥
  "shared_secret":"#############################"  #
 找到的文件中shared_secret就是生成本地令牌的文件，拦截获取获取这个密钥，我们就能够对账号进行解码了。
 
二、令牌是否可复用
1、令牌文件可以复用，但是账号更换令牌后，令牌会重新生成。同时，令牌获取解密在技术上是可行的，但是如何在产品业务侧应用，则需要产品角度考虑了。


